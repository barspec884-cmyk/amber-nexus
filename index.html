<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Amber Nexus - Interactive Controller</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
  <style>
    :root { --bg: #0b0c10; --accent: #c5a880; --panel: rgba(20, 25, 30, 0.9); }
    body { margin: 0; background: var(--bg); color: #fff; font-family: sans-serif; display: flex; height: 100vh; width: 100vw; overflow: hidden; }
    
    #sidebar { width: 320px; background: var(--panel); border-right: 1px solid rgba(197, 168, 128, 0.3); padding: 20px; box-sizing: border-box; overflow-y: auto; backdrop-filter: blur(10px); z-index: 10; }
    #sidebar::-webkit-scrollbar { width: 6px; }
    #sidebar::-webkit-scrollbar-thumb { background: rgba(197, 168, 128, 0.5); border-radius: 3px; }
    
    #main-container { flex: 1; height: 100%; position: relative; background: #000; }
    #main { width: 100%; height: 100%; }
    
    h3 { color: var(--accent); font-size: 14px; border-left: 3px solid var(--accent); padding-left: 8px; margin: 25px 0 15px; }
    .control-group { margin-bottom: 20px; } /* 余白を少し広げました */
    label { display: flex; justify-content: space-between; font-size: 12px; color: #aaa; margin-bottom: 8px; }
    .slider-hint { font-size: 10px; color: #666; margin-top: -6px; margin-bottom: 6px; display: flex; justify-content: space-between; }
    
    /* PC・スマホ共通：スライダーを少し太くして触りやすく */
    input[type=range] { width: 100%; accent-color: var(--accent); cursor: pointer; height: 6px; }
    .val-disp { color: var(--accent); font-weight: bold; }
    
    select.barrel-select { width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(197, 168, 128, 0.5); color: var(--accent); border-radius: 6px; font-size: 14px; outline: none; cursor: pointer; margin-bottom: 5px; }
    select.barrel-select option { background: #1a1a1a; color: #fff; }
    .cask-label { font-size: 11px; color: #888; margin-bottom: 4px; }

    /* --- スマホ専用のUI調整 --- */
    @media (max-width: 768px) {
      body { 
        flex-direction: column; /* スマホでは グラフが上、パネルが下 */
      }
      #sidebar { 
        width: 100%; 
        height: 50vh; /* 画面下半分をスクロール領域に */
        border-right: none; 
        border-top: 1px solid rgba(197, 168, 128, 0.3); 
        padding: 20px 25px 40px; /* 指が届きやすいように余白を調整 */
      }
      #main-container { 
        width: 100%; 
        height: 50vh; /* 画面上半分でグラフを見る */
      }
      .control-group {
        margin-bottom: 28px; /* スマホ時は誤タップを防ぐためスライダー間隔をさらに広げる */
      }
    }
  </style>
</head>
<body>

<div id="sidebar">
  <div style="font-size: 22px; font-weight: bold; color: var(--accent); margin-bottom: 5px;">Amber Nexus</div>
  <div style="font-size: 10px; color: #888; margin-bottom: 15px;">Tasting Topology System</div>

  <h3>基本骨格 (Core Specs)</h3>
  <div class="control-group">
    <label>Age (熟成年数) <span class="val-disp"><span id="v-age">12</span> Years</span></label>
    <div class="slider-hint"><span>Young (暴れる)</span><span>Aged (統合)</span></div>
    <input type="range" id="i-age" min="3" max="30" value="12" oninput="syncParam()">
  </div>
  <div class="control-group">
    <label>ABV (アルコール度数) <span class="val-disp"><span id="v-abv">43</span> %</span></label>
    <div class="slider-hint"><span>40% (穏やか)</span><span>60%+ (爆発的)</span></div>
    <input type="range" id="i-abv" min="40" max="65" value="43" oninput="syncParam()">
  </div>

  <h3>樽の環境 (Cask Atlas)</h3>
  <div class="control-group">
    <div class="cask-label">Base Cask (基本樽)</div>
    <select id="s-barrel" class="barrel-select" onchange="syncParam()">
      <option value="reset">● Standard (基本)</option>
      <option value="bourbon" selected>● Bourbon (バニラ・蜂蜜)</option>
      <option value="american_oak">● American Oak (バニラ・レモン)</option>
      <option value="european_oak">■ European Oak (重厚・タンニン)</option>
      <option value="mizunara">▲ Mizunara (香木・スパイス)</option>
      <option value="px_sherry">◆ PX Sherry (極甘口・レーズン)</option>
    </select>

    <div class="cask-label" style="margin-top: 10px;">Finish Cask (後熟)</div>
    <select id="s-finish" class="barrel-select" onchange="syncParam()">
      <option value="none">なし (None)</option>
      <option value="sauternes">◆ Sauternes (貴腐ワイン・華やか)</option>
      <option value="px_sherry">◆ PX Sherry (極甘口・レーズン)</option>
      <option value="port">◆ Port Wine (赤ベリー・プラム)</option>
      <option value="mizunara">▲ Mizunara (香木・スパイス)</option>
      <option value="beer">■ Beer/IPA/Stout (ホップ・珈琲)</option>
      <option value="rum">● Rum (黒糖・トロピカル)</option>
    </select>
  </div>
  
  <div class="control-group">
    <label>Cask Size (樽の大きさ) <span class="val-disp" id="v-size">3</span></label>
    <div class="slider-hint"><span>Octave (密集)</span><span>Butt (拡散)</span></div>
    <input type="range" id="i-size" min="1" max="5" value="3" oninput="syncParam()">
  </div>

  <h3>テクスチャー (Mouthfeel)</h3>
  <div class="control-group">
    <label>Body (粘度・重さ) <span class="val-disp" id="v-body">5</span></label>
    <input type="range" id="i-body" min="1" max="10" value="5" oninput="syncParam()">
  </div>
  <div class="control-group">
    <label>Crisp (キレ・鮮度) <span class="val-disp" id="v-crisp">5</span></label>
    <input type="range" id="i-crisp" min="1" max="10" value="5" oninput="syncParam()">
  </div>
  <div class="control-group">
    <label>Heat (熱量・アタック) <span class="val-disp" id="v-heat">5</span></label>
    <input type="range" id="i-heat" min="1" max="10" value="5" oninput="syncParam()">
  </div>
  <div class="control-group">
    <label>Grip (収斂味・樽渋) <span class="val-disp" id="v-grip">5</span></label>
    <input type="range" id="i-grip" min="1" max="10" value="5" oninput="syncParam()">
  </div>

  <h3>味わいの座標 (Flavor Matrix)</h3>
  <div class="control-group">
    <label>Sweet (甘口度) <span class="val-disp" id="v-sweet">5</span></label>
    <input type="range" id="i-sweet" min="0" max="10" value="5" oninput="syncParam()">
  </div>
  <div class="control-group">
    <label>Woody (樽香度) <span class="val-disp" id="v-woody">5</span></label>
    <input type="range" id="i-woody" min="0" max="10" value="5" oninput="syncParam()">
  </div>

  <h3>強度 (Intensity)</h3>
  <div class="control-group">
    <label>Aroma (香りの広がり) <span class="val-disp" id="v-aroma">3</span></label>
    <input type="range" id="i-aroma" min="1" max="5" value="3" oninput="syncParam()">
  </div>
  <div class="control-group">
    <label>Finish (余韻の揺れ) <span class="val-disp" id="v-finish">2</span></label>
    <input type="range" id="i-finish" min="1" max="5" value="2" oninput="syncParam()">
  </div>
</div>

<div id="main-container">
  <div id="main"></div>
</div>

<script>
  let myChart;
  let params = {
    barrel: 'bourbon',
    finish: 'none', // 新規パラメータ
    caskSize: 3,
    spec: { age: 12, abv: 43 },
    texture: { body: 5, crisp: 5, heat: 5, grip: 5 },
    matrix: { sweet: 5, woody: 5 },
    intensity: { aroma: 3, finish: 2 }
  };

  const atlasData = {
    bourbon:      { notes: ["Vanilla", "Coconut", "Toffee", "Honey", "Oak"], color: "#f4d03f" },
    american_oak: { notes: ["Vanilla", "Coconut", "Toffee", "Honey", "Oak", "Lemon"], color: "#f4d03f" },
    european_oak: { notes: ["Raisin", "Chocolate", "Nutmeg", "Tannin", "Oak", "Spice"], color: "#5c3a21" },
    mizunara:     { notes: ["Sandalwood", "Incense", "Spice", "Vanilla", "Coconut"], color: "#c5a880" },
    px_sherry:    { notes: ["Raisin", "Chocolate", "Fig", "Syrup", "Plum"], color: "#8c3b3b" },
    sauternes:    { notes: ["Apricot", "Honey", "Floral", "Lemon", "Syrup"], color: "#f1c40f" },
    port:         { notes: ["Plum", "Red Berry", "Chocolate", "Spice", "Tannin"], color: "#782844" },
    beer:         { notes: ["Hops", "Malt", "Coffee", "Chocolate", "Lemon"], color: "#d35400" },
    rum:          { notes: ["Brown Sugar", "Banana", "Pineapple", "Molasses", "Vanilla"], color: "#d68910" },
    none:         { notes: [], color: "#555" },
    reset:        { notes: [], color: "#555" }
  };

  const flavors = [
    { n: "Vanilla", c: "sweet", score: 10, symbol: "circle" }, 
    { n: "Coconut", c: "sweet", score: 7, symbol: "circle" }, 
    { n: "Toffee", c: "sweet", score: 8, symbol: "circle" }, 
    { n: "Honey", c: "sweet", score: 8, symbol: "circle" },
    { n: "Brown Sugar", c: "sweet", score: 9, symbol: "circle" },
    { n: "Banana", c: "sweet", score: 8, symbol: "circle" },
    { n: "Pineapple", c: "sweet", score: 8, symbol: "circle" },
    { n: "Molasses", c: "sweet", score: 9, symbol: "circle" },
    { n: "Malt", c: "sweet", score: 6, symbol: "circle" },
    { n: "Raisin", c: "sweet", score: 8, symbol: "diamond" }, 
    { n: "Fig", c: "sweet", score: 6, symbol: "diamond" }, 
    { n: "Syrup", c: "sweet", score: 5, symbol: "diamond" },
    { n: "Apricot", c: "sweet", score: 8, symbol: "diamond" },
    { n: "Lemon", c: "sweet", score: 7, symbol: "diamond" },
    { n: "Floral", c: "sweet", score: 8, symbol: "diamond" },
    { n: "Plum", c: "sweet", score: 8, symbol: "diamond" },
    { n: "Red Berry", c: "sweet", score: 7, symbol: "diamond" },
    { n: "Oak", c: "woody", score: 8, symbol: "rect" }, 
    { n: "Chocolate", c: "sweet", score: 9, symbol: "rect" }, 
    { n: "Tannin", c: "woody", score: 6, symbol: "rect" },
    { n: "Coffee", c: "woody", score: 8, symbol: "rect" },
    { n: "Spice", c: "woody", score: 8, symbol: "triangle" }, 
    { n: "Sandalwood", c: "woody", score: 9, symbol: "triangle" }, 
    { n: "Incense", c: "woody", score: 6, symbol: "triangle" },
    { n: "Nutmeg", c: "woody", score: 7, symbol: "triangle" },
    { n: "Hops", c: "woody", score: 8, symbol: "triangle" }
  ];

  window.onload = function() {
    myChart = echarts.init(document.getElementById('main'));
    update();
    window.addEventListener('resize', () => { myChart.resize(); update(); });
  };

  function syncParam() {
    params.barrel = document.getElementById('s-barrel').value;
    params.finish = document.getElementById('s-finish').value; // 後熟の値取得
    
    params.spec.age = parseInt(document.getElementById('i-age').value);
    params.spec.abv = parseInt(document.getElementById('i-abv').value);
    params.caskSize = parseInt(document.getElementById('i-size').value);
    params.texture.body = parseInt(document.getElementById('i-body').value);
    params.texture.crisp = parseInt(document.getElementById('i-crisp').value);
    params.texture.heat = parseInt(document.getElementById('i-heat').value);
    params.texture.grip = parseInt(document.getElementById('i-grip').value);
    params.matrix.sweet = parseInt(document.getElementById('i-sweet').value);
    params.matrix.woody = parseInt(document.getElementById('i-woody').value);
    params.intensity.aroma = parseInt(document.getElementById('i-aroma').value);
    params.intensity.finish = parseInt(document.getElementById('i-finish').value);
    
    document.getElementById('v-age').innerText = params.spec.age;
    document.getElementById('v-abv').innerText = params.spec.abv;
    document.getElementById('v-size').innerText = params.caskSize;
    document.getElementById('v-body').innerText = params.texture.body;
    document.getElementById('v-crisp').innerText = params.texture.crisp;
    document.getElementById('v-heat').innerText = params.texture.heat;
    document.getElementById('v-grip').innerText = params.texture.grip;
    document.getElementById('v-sweet').innerText = params.matrix.sweet;
    document.getElementById('v-woody').innerText = params.matrix.woody;
    document.getElementById('v-aroma').innerText = params.intensity.aroma;
    document.getElementById('v-finish').innerText = params.intensity.finish;
    
    update();
  }

  function update() {
    if(!myChart) return;
    const width = myChart.getWidth();
    const height = myChart.getHeight();

    let coreColor = '#c5a880';
    if(params.texture.heat > 5) {
        const heatRatio = (params.texture.heat - 5) / 5;
        coreColor = heatRatio > 0.5 ? '#d97a33' : '#ce9159'; 
    }
    const coreGlow = 10 + (params.spec.age * 1.5) + (params.texture.heat * 2);

    const shiftX = (params.matrix.sweet - 5) * 30;
    const shiftY = (params.matrix.woody - 5) * 30;

    const nodes = [{
      name: 'Amber Palette', 
      symbolSize: 60, 
      itemStyle: { color: coreColor, shadowBlur: coreGlow, shadowColor: coreColor },
      label: { show: true, position: 'inside', fontSize: 10, fontWeight: 'bold' },
      x: (width / 2) + shiftX,
      y: (height / 2) + shiftY,
      fixed: true 
    }];
    
    const links = [];
    const baseAtlas = atlasData[params.barrel];
    const finishAtlas = atlasData[params.finish];
    
    const calculatedEdgeLength = 40 + (params.caskSize - 1) * 20;
    const baseLineWidth = 0.5 + (params.texture.body * 0.3);

    flavors.forEach(f => {
      const isBaseNote = baseAtlas.notes.includes(f.n);
      const isFinishNote = finishAtlas.notes.includes(f.n);
      const isActive = isBaseNote || isFinishNote;

      if (!isActive) {
        nodes.push({
          name: f.n, symbol: f.symbol || 'circle', symbolSize: f.score * 2,
          itemStyle: { color: '#444', opacity: 0.4 }
        });
        links.push({
          source: 'Amber Palette', target: f.n, edgeLength: calculatedEdgeLength,
          lineStyle: { width: baseLineWidth, color: 'rgba(255,255,255,0.1)' }
        });
        return;
      }

      // ベースとフィニッシュの掛け合わせロジック
      let nodeColor, lineColor, lineType, lineWidth, edgeLen;
      
      if (isBaseNote && isFinishNote) {
          // 両方に共通する香り（重なって強調される）
          nodeColor = baseAtlas.color;
          lineColor = baseAtlas.color;
          lineType = 'solid';
          lineWidth = baseLineWidth * 3; // ひときわ太く
          edgeLen = calculatedEdgeLength * 0.8; // コアに強く結びつく
      } else if (isBaseNote) {
          // ベース由来の香り
          nodeColor = baseAtlas.color;
          lineColor = baseAtlas.color;
          lineType = 'solid';
          lineWidth = baseLineWidth * 2;
          edgeLen = calculatedEdgeLength;
      } else {
          // フィニッシュのみ由来の香り（後付けのニュアンス）
          nodeColor = finishAtlas.color;
          lineColor = finishAtlas.color;
          lineType = 'dashed'; // 破線でニュアンスを表現
          lineWidth = baseLineWidth * 1.5;
          edgeLen = calculatedEdgeLength * 1.3; // 少し外側を漂わせる
      }

      nodes.push({
        name: f.n,
        symbol: f.symbol || 'circle',
        symbolSize: f.score * 3.5,
        itemStyle: { color: nodeColor, opacity: 1 }
      });

      links.push({
        source: 'Amber Palette', target: f.n,
        edgeLength: edgeLen,
        lineStyle: { width: lineWidth, color: lineColor, type: lineType }
      });
    });

    const explosionForce = (params.intensity.aroma * 50) + (params.spec.abv * 4);
    
    let integrationFriction = 0.05 + (params.spec.age * 0.015);
    integrationFriction -= (params.texture.crisp * 0.005); 
    if(integrationFriction < 0.01) integrationFriction = 0.01;

    const gripGravity = 0.1 + (params.texture.grip * 0.04) - (params.intensity.finish * 0.02);

    myChart.setOption({
      backgroundColor: '#000',
      series: [{
        type: 'graph', layout: 'force', data: nodes, links: links,
        left: 'center', top: 'middle',
        label: { show: true, position: 'top', color: '#fff', fontSize: 11 },
        force: { repulsion: explosionForce, gravity: gripGravity, friction: integrationFriction },
        roam: true, draggable: true
      }]
    });
  }

</script>
</body>
</html>