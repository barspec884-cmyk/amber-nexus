<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Amber Nexus - Interactive Controller</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
  <style>
    :root { --bg: #0b0c10; --accent: #c5a880; --panel: rgba(20, 25, 30, 0.9); }
    body { margin: 0; background: var(--bg); color: #fff; font-family: sans-serif; display: flex; height: 100vh; width: 100vw; overflow: hidden; }
    
    #sidebar { width: 320px; background: var(--panel); border-right: 1px solid rgba(197, 168, 128, 0.3); padding: 20px; box-sizing: border-box; overflow-y: auto; backdrop-filter: blur(10px); z-index: 10; }
    #sidebar::-webkit-scrollbar { width: 6px; }
    #sidebar::-webkit-scrollbar-thumb { background: rgba(197, 168, 128, 0.5); border-radius: 3px; }
    
    #main-container { flex: 1; height: 100%; position: relative; background: #000; }
    #main { width: 100%; height: 100%; }
    
    h3 { color: var(--accent); font-size: 13px; border-left: 3px solid var(--accent); padding-left: 8px; margin: 20px 0 12px; }
    .control-group { margin-bottom: 20px; }
    label { display: flex; justify-content: space-between; font-size: 12px; color: #aaa; margin-bottom: 8px; }
    .slider-hint { font-size: 10px; color: #666; margin-top: -4px; margin-bottom: 4px; display: flex; justify-content: space-between; }
    input[type=range] { width: 100%; accent-color: var(--accent); cursor: pointer; height: 6px; }
    .val-disp { color: var(--accent); font-weight: bold; }
    
    .barrel-btn { width: 100%; padding: 12px; margin-bottom: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #ccc; border-radius: 8px; cursor: pointer; font-size: 12px; text-align: left; transition: 0.3s; }
    .barrel-btn:hover { background: rgba(197, 168, 128, 0.2); }
    .dl-btn { text-align: center; font-weight: bold; margin-top: 10px; border-color: var(--accent); color: #fff; background: rgba(197, 168, 128, 0.3); }

    select.barrel-select { width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(197, 168, 128, 0.5); color: var(--accent); border-radius: 6px; font-size: 13px; outline: none; cursor: pointer; margin-bottom: 5px; }
    select.barrel-select option { background: #1a1a1a; color: #fff; }
    .cask-label { font-size: 11px; color: #888; margin-bottom: 4px; }

    /* --- スマホ専用のUI調整 --- */
    @media (max-width: 768px) {
      body { flex-direction: column-reverse; }
      #sidebar { width: 100%; height: 50vh; border-right: none; border-top: 1px solid rgba(197, 168, 128, 0.3); padding: 20px 25px 40px; }
      #main-container { width: 100%; height: 50vh; }
      .control-group { margin-bottom: 28px; }
    }
  </style>
</head>
<body>

<div id="sidebar">
  <div style="font-size: 22px; font-weight: bold; color: var(--accent); margin-bottom: 5px;">Amber Nexus</div>
  <div style="font-size: 10px; color: #888; margin-bottom: 15px;">Tasting Topology System</div>

  <h3>山崎 垂直比較 (Yamazaki Vertical)</h3>
  <div class="control-group">
    <button class="barrel-btn" onclick="applyPreset('yamazaki_nas')">🍓 山崎 NAS (ワイン樽由来の華やかさ)</button>
    <button class="barrel-btn" onclick="applyPreset('yamazaki_12y')">🍁 山崎 12年 (黄金のミズナラバランス)</button>
    <button class="barrel-btn" onclick="applyPreset('yamazaki_18y')">🍷 山崎 18年 (重厚なシェリーと深み)</button>
  </div>

  <h3>基本骨格 (Core Specs)</h3>
  <div class="control-group">
    <label>Age (熟成年数) <span class="val-disp"><span id="v-age">12</span> Years</span></label>
    <div class="slider-hint"><span>Young (暴れる)</span><span>Aged (統合)</span></div>
    <input type="range" id="i-age" min="3" max="30" value="12" oninput="syncParam()">
  </div>
  <div class="control-group">
    <label>ABV (アルコール度数) <span class="val-disp"><span id="v-abv">43</span> %</span></label>
    <div class="slider-hint"><span>40% (穏やか)</span><span>60%+ (爆発的)</span></div>
    <input type="range" id="i-abv" min="40" max="65" value="43" oninput="syncParam()">
  </div>

  <h3>樽の環境 (Cask Atlas)</h3>
  <div class="control-group">
    <div class="cask-label">Base Cask (基本樽)</div>
    <select id="s-barrel" class="barrel-select" onchange="syncParam()">
      <option value="bourbon">● Bourbon (バニラ・蜂蜜)</option>
      <option value="american_oak" selected>● American Oak (バニラ・レモン)</option>
      <option value="european_oak">■ European Oak (重厚・タンニン)</option>
      <option value="mizunara">▲ Mizunara (香木・スパイス)</option>
      <option value="px_sherry">◆ PX Sherry (極甘口・レーズン)</option>
      <option value="port">◆ Port Wine (赤ベリー・プラム)</option>
    </select>
    <div class="cask-label" style="margin-top: 10px;">Finish Cask (後熟)</div>
    <select id="s-finish" class="barrel-select" onchange="syncParam()">
      <option value="none">なし (None)</option>
      <option value="mizunara">▲ Mizunara (香木・スパイス)</option>
      <option value="sauternes">◆ Sauternes (貴腐ワイン・華やか)</option>
      <option value="px_sherry">◆ PX Sherry (極甘口・レーズン)</option>
    </select>
  </div>
  
  <h3>テクスチャー (Mouthfeel)</h3>
  <div class="control-group">
    <label>Body (粘度・重さ) <span class="val-disp" id="v-body">5</span></label>
    <input type="range" id="i-body" min="1" max="10" value="5" oninput="syncParam()">
  </div>
  <div class="control-group">
    <label>Crisp (キレ・鮮度) <span class="val-disp" id="v-crisp">5</span></label>
    <input type="range" id="i-crisp" min="1" max="10" value="5" oninput="syncParam()">
  </div>
  <div class="control-group">
    <label>Grip (収斂味・樽渋) <span class="val-disp" id="v-grip">5</span></label>
    <input type="range" id="i-grip" min="1" max="10" value="5" oninput="syncParam()">
  </div>

  <h3>味わいの座標 (Flavor Matrix)</h3>
  <div class="control-group">
    <label>Sweet (甘口度) <span class="val-disp" id="v-sweet">5</span></label>
    <input type="range" id="i-sweet" min="0" max="10" value="5" oninput="syncParam()">
  </div>
  <div class="control-group">
    <label>Woody (樽香度) <span class="val-disp" id="v-woody">5</span></label>
    <input type="range" id="i-woody" min="0" max="10" value="5" oninput="syncParam()">
  </div>

  <button class="barrel-btn dl-btn" onclick="downloadImage()">📸 画像として保存</button>
  <div style="height: 40px;"></div>
</div>

<div id="main-container">
  <div id="main"></div>
</div>

<script>
  let myChart;
  let params = {
    barrel: 'american_oak', finish: 'mizunara', caskSize: 3,
    spec: { age: 12, abv: 43 },
    texture: { body: 5, crisp: 5, heat: 5, grip: 5 },
    matrix: { sweet: 5, woody: 5 },
    intensity: { aroma: 4, finish: 3 }
  };

  const presetData = {
    yamazaki_nas: {
      barrel: 'port', finish: 'mizunara', spec: { age: 8, abv: 43 },
      texture: { body: 4, crisp: 8, heat: 6, grip: 3 }, matrix: { sweet: 7, woody: 4 }, intensity: { aroma: 5, finish: 2 }
    },
    yamazaki_12y: {
      barrel: 'american_oak', finish: 'mizunara', spec: { age: 12, abv: 43 },
      texture: { body: 6, crisp: 5, heat: 4, grip: 5 }, matrix: { sweet: 6, woody: 6 }, intensity: { aroma: 4, finish: 4 }
    },
    yamazaki_18y: {
      barrel: 'px_sherry', finish: 'mizunara', spec: { age: 18, abv: 43 },
      texture: { body: 9, crisp: 3, heat: 3, grip: 8 }, matrix: { sweet: 9, woody: 8 }, intensity: { aroma: 3, finish: 5 }
    }
  };

  const atlasData = {
    american_oak: { notes: ["Vanilla", "Coconut", "Honey", "Oak", "Lemon"], color: "#f4d03f" },
    mizunara:     { notes: ["Sandalwood", "Incense", "Spice", "Vanilla"], color: "#c5a880" },
    px_sherry:    { notes: ["Raisin", "Chocolate", "Fig", "Plum"], color: "#8c3b3b" },
    port:         { notes: ["Red Berry", "Plum", "Chocolate", "Floral"], color: "#782844" },
    sauternes:    { notes: ["Apricot", "Honey", "Floral", "Lemon"], color: "#f1c40f" },
    bourbon:      { notes: ["Vanilla", "Toffee", "Honey", "Oak"], color: "#f4d03f" },
    none:         { notes: [], color: "#555" }
  };

  const flavors = [
    { n: "Vanilla", c: "sweet", score: 10, symbol: "circle" }, { n: "Honey", c: "sweet", score: 8, symbol: "circle" },
    { n: "Raisin", c: "sweet", score: 9, symbol: "diamond" }, { n: "Red Berry", c: "sweet", score: 8, symbol: "diamond" },
    { n: "Plum", c: "sweet", score: 7, symbol: "diamond" }, { n: "Sandalwood", c: "woody", score: 10, symbol: "triangle" },
    { n: "Incense", c: "woody", score: 8, symbol: "triangle" }, { n: "Spice", c: "woody", score: 7, symbol: "triangle" },
    { n: "Oak", c: "woody", score: 8, symbol: "rect" }, { n: "Chocolate", c: "sweet", score: 9, symbol: "rect" },
    { n: "Tannin", c: "woody", score: 6, symbol: "rect" }, { n: "Fig", c: "sweet", score: 7, symbol: "diamond" }
  ];

  window.onload = function() {
    myChart = echarts.init(document.getElementById('main'));
    update();
    window.addEventListener('resize', () => { myChart.resize(); update(); });
  };

  function applyPreset(id) {
    const p = presetData[id];
    document.getElementById('s-barrel').value = p.barrel;
    document.getElementById('s-finish').value = p.finish;
    document.getElementById('i-age').value = p.spec.age;
    document.getElementById('i-abv').value = p.spec.abv;
    document.getElementById('i-body').value = p.texture.body;
    document.getElementById('i-crisp').value = p.texture.crisp;
    document.getElementById('i-grip').value = p.texture.grip;
    document.getElementById('i-sweet').value = p.matrix.sweet;
    document.getElementById('i-woody').value = p.matrix.woody;
    syncParam();
  }

  function downloadImage() {
    const url = myChart.getDataURL({ type: 'png', pixelRatio: 2, backgroundColor: '#000' });
    const a = document.createElement('a'); a.download = 'yamazaki-topology.png'; a.href = url; a.click();
  }

  function syncParam() {
    params.barrel = document.getElementById('s-barrel').value;
    params.finish = document.getElementById('s-finish').value;
    params.spec.age = parseInt(document.getElementById('i-age').value);
    params.spec.abv = parseInt(document.getElementById('i-abv').value);
    params.texture.body = parseInt(document.getElementById('i-body').value);
    params.texture.crisp = parseInt(document.getElementById('i-crisp').value);
    params.texture.grip = parseInt(document.getElementById('i-grip').value);
    params.matrix.sweet = parseInt(document.getElementById('i-sweet').value);
    params.matrix.woody = parseInt(document.getElementById('i-woody').value);
    document.getElementById('v-age').innerText = params.spec.age;
    document.getElementById('v-abv').innerText = params.spec.abv;
    document.getElementById('v-body').innerText = params.texture.body;
    document.getElementById('v-crisp').innerText = params.texture.crisp;
    document.getElementById('v-grip').innerText = params.texture.grip;
    document.getElementById('v-sweet').innerText = params.matrix.sweet;
    document.getElementById('v-woody').innerText = params.matrix.woody;
    update();
  }

  function update() {
    if(!myChart) return;
    const width = myChart.getWidth(), height = myChart.getHeight();
    const coreGlow = 10 + (params.spec.age * 1.5);
    const nodes = [{
      name: 'Amber Palette', symbolSize: 60, fixed: true,
      itemStyle: { color: '#c5a880', shadowBlur: coreGlow, shadowColor: '#c5a880' },
      x: (width / 2) + (params.matrix.sweet - 5) * 25,
      y: (height / 2) + (params.matrix.woody - 5) * 25
    }];
    const links = [];
    const baseAtlas = atlasData[params.barrel], finishAtlas = atlasData[params.finish];

    flavors.forEach(f => {
      const isBase = baseAtlas.notes.includes(f.n), isFinish = finishAtlas.notes.includes(f.n);
      if(!isBase && !isFinish) return;

      nodes.push({
        name: f.n, symbol: f.symbol, symbolSize: f.score * 3.5,
        itemStyle: { color: isBase ? baseAtlas.color : finishAtlas.color }
      });
      links.push({
        source: 'Amber Palette', target: f.n,
        edgeLength: isFinish ? 120 : 80,
        lineStyle: { width: isBase && isFinish ? 5 : 2, type: isFinish ? 'dashed' : 'solid', color: isBase ? baseAtlas.color : finishAtlas.color }
      });
    });

    myChart.setOption({
      backgroundColor: '#000',
      series: [{
        type: 'graph', layout: 'force', data: nodes, links: links,
        label: { show: true, position: 'top', color: '#fff' },
        force: { repulsion: 250 + (params.spec.abv * 2), gravity: 0.1 + (params.texture.grip * 0.03), friction: 0.05 + (params.spec.age * 0.01) }
      }]
    });
  }
</script>
</body>
</html>